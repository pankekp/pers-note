# MySQL 查询

---

## 1. 慢 SQL 场景

大多数情况正常，偶尔很慢：

* 数据库在刷新脏页：当数据库写数据时会在内存中更新字段，新数据不会马上同步到磁盘中，而是将更新操作记录在 redo log 中，空隙时才进行磁盘数据的同步。当 redo log 写满时，数据库就需要暂停其他操作而将数据同步到磁盘，这时就会导致 SQL 执行变慢
* 等待锁：等待表锁或行锁会直接导致 SQL 执行变慢，SHOW PROCESSLIST 命令可以查看查询是否处于 Locked 状态

始终执行很慢：

* 没有使用到索引：典型的如建立索引的列参与了表达式就不会用到索引
* 选择索引错误：数据库在查询时会对查询扫描的行数进行预测，选择全表扫描或者使用索引。行数的预测是通过索引的基数得出的，而索引的基数是通过対部分数据进行采用来预测索引的基数，所以会引起偏差，导致出现没有使用索引的情况

## 2. 捕获慢 SQL

使用慢查询日志捕获查询时间超过一定值的查询。

使用 EXPLAIN 查看查询的执行计划，这个命令查看的是查询优化器如何决定执行查询，其中较为重要的列有：

* type：如何查找行，如通过索引、全表扫描
* rows：预计读取的行数
* possible_keys：可以使用哪些索引
* key：决定使用哪个索引
* select_key：查询类型，如简单查询、联合查询、子查询

## 3. 优化慢 SQL

**不要请求多余的数据**：

* 使用 LIMIT：限制数据库只返回需要的数据，而不是查询全部结果只选择一小部分而将其他数据抛弃
  * LIMIT 1：当查询结果只有一条时，数据库在查找到后会立刻返回不会继续查询
* 不要总使用 SELECT *
* 缓存重复查询相同的数据

**减少额外扫描的记录**：

* 使用[覆盖索引](../index/index.md#cover_index)
* 改变表的结构：使用单独的汇总表

**重构查询方式**：

* 切分大查询：如将定期删除大量旧数据的操作分解为在一个长时间段中多次操作，能够有效减少锁的竞争，分散服务器压力
* 分解大连接查询：将具有多个 JOIN 的查询分解为多次查询，执行单个的查询可以减少锁的竞争；数据库不进行关联查询，减少了相同记录的访问次数；将数据在应用层关联，更易扩展和优化性能

## 4. 查询执行过程

MySQL 的查询过程大致如下：

1. 客户端发送查询给服务器
MySQL 的客户端和服务器之间是「半双工」通信，也就是说当服务器响应客户端的请求时，数据发送停止之前，客户端只能被动地接收，这也是为什么在必要时需要使用 LIMIT 的原因：如果需要 10 条数据，查询结果包含 100 条数据，当客户端已经收到需要的 10 条数据后，通信机制导致无法阻止后续数据的发送
2. 服务器检查查询缓存，命中则直接返回结果（8.0 中取消了这个功能）
3. 将 SQL 进行解析、预处理，由查询优化器生成执行计划
    * MySQL 的查询优化器基于成本优化，尝试预测多种执行计划的成本从而选择最小的一个，但是存在很多原因会导致优化器选择错误执行计划，第 1 节中提到的索引基数偏差就是原因之一
    * MySQL 的查询优化能够处理一些特定的优化类型，典型的如覆盖索引和使用 LIMIT 提前终止查询
    * 索引的统计信息没有保存在服务器层，而是由存储引擎实现，查询优化器在生成查询执行计划时需要向其获取统计信息如前边提到的索引的基数等
4. 根据查询执行计划调用存储引擎 API 执行查询
查询过程中存在大量操作需要调用存储引擎实现的接口来完成，丰富的查询引擎的功能由底层的接口承担，这种接口模式让 MySQL 的存储引擎像插件一样存在
5. 将结果返回给客户端

## 5. 特定的查询优化

limit：

* limit 的用法是 `limit [offset], [rows]`，其中 offset 表示偏移值， rows 表示需要返回的数据行数
* limit 在 offset 过大时会很慢，因为 limit 在执行时会不断的查询数据直到查询出 offset + rows 条数据，然后抛弃前 offset 条，返回 rows 条：

  ```sql
  SELECT * FROM tableName ORDER BY id LIMIT 500000,1;

  SELECT * FROM tableName
  WHERE id >= (SELECT id FROM tableName ORDER BY id LIMIT 500000 , 1)
  LIMIT 1;
  ```

  相比于第一种写法，子查询用到了索引，所以效率提高很多。因此对 limit 优化可以先获取到 offset 的那一行数据，然后使用 `limit size` 仅获取数据。
  